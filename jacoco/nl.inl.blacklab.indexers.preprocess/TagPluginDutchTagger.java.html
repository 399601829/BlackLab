<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TagPluginDutchTagger.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BlackLab</a> &gt; <a href="index.source.html" class="el_package">nl.inl.blacklab.indexers.preprocess</a> &gt; <span class="el_source">TagPluginDutchTagger.java</span></div><h1>TagPluginDutchTagger.java</h1><pre class="source lang-java linenums">package nl.inl.blacklab.indexers.preprocess;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.Reader;
import java.io.Writer;
import java.lang.reflect.Method;
import java.net.URL;
import java.net.URLClassLoader;
import java.nio.charset.Charset;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Optional;
import java.util.Properties;
import java.util.jar.Manifest;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.io.IOUtils;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.NullNode;
import com.fasterxml.jackson.databind.node.ObjectNode;

<span class="nc" id="L28">public class TagPluginDutchTagger implements TagPlugin {</span>
    private static final String PROP_JAR = &quot;jarPath&quot;;
    private static final String PROP_VECTORS = &quot;vectorFile&quot;;
    private static final String PROP_MODEL = &quot;modelFile&quot;;
    private static final String PROP_LEXICON = &quot;lexiconFile&quot;;

    private static final String VERSION = &quot;0.2&quot;;
    private ClassLoader loader;

    /** The object doing the actual conversion */
<span class="nc" id="L38">    private Object converter = null;</span>

    private Method handleFile;

    @Override
    public void init(Optional&lt;ObjectNode&gt; configNode) throws PluginException {
<span class="nc" id="L44">        ObjectNode config = configNode.orElseThrow(() -&gt; new PluginException(&quot;This plugin requires configuration&quot;));</span>

<span class="nc" id="L46">        File jar = new File(configStr(config, PROP_JAR));</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        if (!jar.exists())</span>
<span class="nc" id="L48">            throw new PluginException(&quot;Could not find the dutchTagger jar at location &quot; + jar.toString());</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (!jar.canRead())</span>
<span class="nc" id="L50">            throw new PluginException(&quot;Could not read the dutchTagger jar at location &quot; + jar.toString());</span>
        try {
<span class="nc" id="L52">            URL jarUrl = jar.toURI().toURL();</span>
<span class="nc" id="L53">            loader = new URLClassLoader(new URL[] { jarUrl }, null);</span>
<span class="nc" id="L54">            assertVersion(loader);</span>

<span class="nc" id="L56">            Properties converterProps = new Properties();</span>
<span class="nc" id="L57">            converterProps.setProperty(&quot;word2vecFile&quot;, configStr(config, PROP_VECTORS));</span>
<span class="nc" id="L58">            converterProps.setProperty(&quot;taggingModel&quot;, configStr(config, PROP_MODEL));</span>
<span class="nc" id="L59">            converterProps.setProperty(&quot;lexiconPath&quot;, configStr(config, PROP_LEXICON));</span>
<span class="nc" id="L60">            converterProps.setProperty(&quot;tokenize&quot;, &quot;true&quot;);</span>

<span class="nc" id="L62">            Class&lt;?&gt; converterClass = loader.loadClass(&quot;nl.namescape.tagging.ImpactTaggerLemmatizerClient&quot;);</span>
<span class="nc" id="L63">            Method setProperties = converterClass.getMethod(&quot;setProperties&quot;, Properties.class);</span>
<span class="nc" id="L64">            handleFile = converterClass.getMethod(&quot;handleFile&quot;, String.class, String.class);</span>

<span class="nc" id="L66">            converter = converterClass.newInstance();</span>
<span class="nc" id="L67">            setProperties.invoke(converter, converterProps);</span>
<span class="nc" id="L68">        } catch (Exception e) {</span>
<span class="nc" id="L69">            throw new PluginException(&quot;Error initializing DutchTaggerLemmatizer plugin&quot;, e);</span>
<span class="nc" id="L70">        }</span>
<span class="nc" id="L71">    }</span>

    @Override
    public synchronized void perform(Reader reader, Writer writer) throws PluginException {
        // Set the ContextClassLoader to use the UrlClassLoader we pointed at the OpenConvert jar.
        // This is required because OpenConvert implicitly loads some dependencies through locators/providers (such as its xml transformers)
        // and these locators/providers sometimes prefer to use the ContextClassLoader, which may have been set by a servlet container or the like.
        // If those cases, the contextClassLoader does not have the jar we loaded on its classpath, and so it cannot find the correct classes.
<span class="nc" id="L79">        ClassLoader originalClassLoader = Thread.currentThread().getContextClassLoader();</span>
<span class="nc" id="L80">        Thread.currentThread().setContextClassLoader(loader);</span>
        try {
<span class="nc" id="L82">            performImpl(reader, writer);</span>
        } finally {
<span class="nc" id="L84">            Thread.currentThread().setContextClassLoader(originalClassLoader);</span>
<span class="nc" id="L85">        }</span>
<span class="nc" id="L86">    }</span>

    private synchronized void performImpl(Reader reader, Writer writer) throws PluginException {
<span class="nc" id="L89">        Path tmpInput = null;</span>
<span class="nc" id="L90">        Path tmpOutput = null;</span>
        try {
<span class="nc" id="L92">            tmpInput = Files.createTempFile(&quot;&quot;, &quot;.xml&quot;);</span>
<span class="nc" id="L93">            tmpOutput = Files.createTempFile(&quot;&quot;, &quot;.xml&quot;);</span>

            // Use this, as the tagger is a little dumb and doesn't allow us to specify a charset
<span class="nc" id="L96">            final Charset intermediateCharset = Charset.defaultCharset();</span>
<span class="nc" id="L97">            try (FileOutputStream os = new FileOutputStream(tmpInput.toFile())) {</span>
<span class="nc" id="L98">                IOUtils.copy(reader, os, intermediateCharset);</span>
<span class="nc bnc" id="L99" title="All 8 branches missed.">            }</span>

<span class="nc" id="L101">            handleFile.invoke(converter, tmpInput.toString(), tmpOutput.toString());</span>

<span class="nc" id="L103">            try (FileInputStream fis = new FileInputStream(tmpOutput.toFile())) {</span>
<span class="nc" id="L104">                IOUtils.copy(fis, writer, intermediateCharset);</span>
<span class="nc bnc" id="L105" title="All 8 branches missed.">            }</span>
<span class="nc" id="L106">        } catch (Exception e) {</span>
<span class="nc" id="L107">            throw new PluginException(&quot;Could not tag file: &quot; + e.getMessage(), e);</span>
        } finally {
<span class="nc bnc" id="L109" title="All 4 branches missed.">            if (tmpInput != null)</span>
<span class="nc" id="L110">                FileUtils.deleteQuietly(tmpInput.toFile());</span>
<span class="nc bnc" id="L111" title="All 4 branches missed.">            if (tmpOutput != null)</span>
<span class="nc" id="L112">                FileUtils.deleteQuietly(tmpOutput.toFile());</span>
<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">    }</span>

    /**
     * Read a value from our config if present.
     *
     * @param config root node of our config object
     * @param nodeName node to read
     * @return the value as a string
     * @throws PluginException on missing key or null value
     */
    private static String configStr(ObjectNode config, String nodeName) throws PluginException {
<span class="nc" id="L125">        JsonNode n = config.get(nodeName);</span>
<span class="nc bnc" id="L126" title="All 4 branches missed.">        if (n == null || n instanceof NullNode)</span>
<span class="nc" id="L127">            throw new PluginException(&quot;Missing configuration value &quot; + nodeName);</span>

<span class="nc" id="L129">        return n.asText();</span>
    }

    @Override
    public String getInputFormat() {
<span class="nc" id="L134">        return &quot;tei&quot;;</span>
    }

    @Override
    public String getOutputFormatIdentifier() {
<span class="nc" id="L139">        return &quot;tei&quot;;</span>
    }

    @Override
    public String getOutputFileName(String inputFileName) {
<span class="nc" id="L144">        return FilenameUtils.removeExtension(inputFileName).concat(&quot;.xml&quot;);</span>
    }

    @Override
    public String getId() {
<span class="nc" id="L149">        return &quot;DutchTagger&quot;;</span>
    }

    @Override
    public String getDisplayName() {
<span class="nc" id="L154">        return &quot;DutchTagger&quot;;</span>
    }

    @Override
    public String getDescription() {
<span class="nc" id="L159">        return &quot;Tags dutch text in the TEI format&quot;;</span>
    }

    /**
     * Ensure that the maven artifact version matches VERSION
     *
     * @param loader
     * @throws PluginException
     */
    private static void assertVersion(ClassLoader loader) throws PluginException {
<span class="nc" id="L169">        try (InputStream is = loader.getResourceAsStream(&quot;META-INF/MANIFEST.MF&quot;)) {</span>
<span class="nc" id="L170">            Manifest manifest = new Manifest(is);</span>
<span class="nc" id="L171">            String version = manifest.getMainAttributes().getValue(&quot;Specification-Version&quot;);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (!version.equals(VERSION))</span>
<span class="nc" id="L173">                throw new PluginException(&quot;Mismatched version! Expected &quot; + VERSION + &quot; but found &quot; + version);</span>
<span class="nc bnc" id="L174" title="All 8 branches missed.">        } catch (IOException e) {</span>
<span class="nc" id="L175">            throw new PluginException(&quot;Could not read manifest: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L176">        }</span>
<span class="nc" id="L177">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>