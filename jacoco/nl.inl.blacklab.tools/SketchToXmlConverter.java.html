<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SketchToXmlConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BlackLab</a> &gt; <a href="index.source.html" class="el_package">nl.inl.blacklab.tools</a> &gt; <span class="el_source">SketchToXmlConverter.java</span></div><h1>SketchToXmlConverter.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2010, 2012 Institute for Dutch Lexicology
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *******************************************************************************/
package nl.inl.blacklab.tools;

import java.io.BufferedOutputStream;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.Reader;
import java.io.UnsupportedEncodingException;
import java.io.Writer;
import java.util.List;
import java.util.Properties;

import nl.inl.blacklab.index.Indexer;
import nl.inl.util.FileUtil;
import nl.inl.util.StringUtil;

/**
 * Convert the ANW Corpus Sketch format files to almost-identical XML files. Using XML is useful
 * because it allows us to later easily display it using XSLT.
 */
<span class="nc" id="L42">public class SketchToXmlConverter {</span>
	public static void main(String[] args) throws Exception {
		// Read property file
<span class="nc" id="L45">		Properties properties = getPropertiesFromResource(&quot;anwcorpus.properties&quot;);</span>

<span class="nc" id="L47">		File inDir = getFileProp(properties, &quot;sketchDir&quot;, null);</span>
<span class="nc" id="L48">		File listFile = new File(inDir, &quot;lijst.txt&quot;);</span>

<span class="nc" id="L50">		File outDir = getFileProp(properties, &quot;inputDir&quot;, &quot;input&quot;, null);</span>

<span class="nc" id="L52">		SketchToXmlConverter.convertList(listFile, inDir, outDir);</span>
<span class="nc" id="L53">	}</span>

	/**
	 * Read Properties from a resource
	 *
	 * @param resourcePath
	 *            file path, relative to the classpath, where the properties file is
	 * @return the Properties read
	 * @throws IOException
	 */
	public static Properties getPropertiesFromResource(String resourcePath) throws IOException {
		Properties properties;
<span class="nc" id="L65">		try (InputStream isProps = SketchToXmlConverter.class.getClassLoader().getResourceAsStream(resourcePath)) {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">			if (isProps == null) {</span>
<span class="nc" id="L67">				throw new IllegalArgumentException(&quot;Properties file not found: &quot; + resourcePath</span>
						+ &quot; (must be accessible from the classpath)&quot;);
			}
<span class="nc" id="L70">			properties = new Properties();</span>
<span class="nc" id="L71">			properties.load(isProps);</span>
<span class="nc" id="L72">			return properties;</span>
<span class="nc bnc" id="L73" title="All 8 branches missed.">		}</span>
	}

	/**
	 * Get a File property from a Properties object.
	 *
	 * This may be an absolute file path (starts with / or \ or a Windows drive letter spec), or a
	 * path relative to basePath
	 *
	 * @param properties
	 *            where to read the value from
	 * @param name
	 *            the value's name
	 * @param basePath
	 *            base path the file path may be relative to
	 * @return the file, or null if not found
	 */
	public static File getFileProp(Properties properties, String name, File basePath) {
<span class="nc" id="L91">		return getFileProp(properties, name, null, basePath);</span>
	}

	/**
	 * Get a File property from a Properties object.
	 *
	 * This may be an absolute file path (starts with / or \ or a Windows drive letter spec), or a
	 * path relative to basePath
	 *
	 * @param properties
	 *            where to read the value from
	 * @param name
	 *            the value's name
	 * @param defaultValue default value if the property was not specified
	 * @param basePath
	 *            base path the file path may be relative to
	 * @return the file, or null if not found
	 */
	public static File getFileProp(Properties properties, String name, String defaultValue, File basePath) {
<span class="nc" id="L110">		Object prop = properties.get(name);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (prop == null)</span>
<span class="nc" id="L112">			prop = defaultValue;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">		if (prop == null)</span>
<span class="nc" id="L114">			return null;</span>
<span class="nc" id="L115">		File filePath = new File(prop.toString());</span>

		// Is it an absolute path, or no base path given?
<span class="nc bnc" id="L118" title="All 4 branches missed.">		if (basePath == null || filePath.isAbsolute()) {</span>
			// Yes; ignore our base directory
<span class="nc" id="L120">			return filePath;</span>
		}
		// Relative path; concatenate with base directory
<span class="nc" id="L123">		return new File(basePath, filePath.getPath());</span>
	}
	private static final int LINES_PER_CHUNK_FILE = 30000;

<span class="nc" id="L127">	boolean inSentence = false;</span>

<span class="nc" id="L129">	boolean inDoc = false;</span>

	private int linesDone;

<span class="nc" id="L133">	private boolean docWasEmpty = true;</span>

<span class="nc" id="L135">	private String lastDocLine = &quot;(no docs processed yet)&quot;;</span>

	public boolean processLine(String line, Writer out) throws IOException {
<span class="nc" id="L138">		boolean shouldContinue = true;</span>
<span class="nc bnc" id="L139" title="All 6 branches missed.">		if (line.length() &gt;= 1 &amp;&amp; line.charAt(0) == '&lt;' &amp;&amp; line.endsWith(&quot;&gt;&quot;)) // tag?</span>
		{
<span class="nc bnc" id="L141" title="All 2 branches missed.">			if (line.charAt(1) == '/') {</span>
				// end tag
<span class="nc bnc" id="L143" title="All 2 branches missed.">				if (line.equals(&quot;&lt;/s&gt;&quot;)) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">					if (!inSentence)</span>
<span class="nc" id="L145">						System.err.println(&quot;Sentence close without open!&quot;);</span>
<span class="nc" id="L146">					inSentence = false;</span>
<span class="nc" id="L147">					docWasEmpty = false;</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">				} else if (line.equals(&quot;&lt;/doc&gt;&quot;)) {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">					if (!inDoc)</span>
<span class="nc" id="L150">						System.err.println(&quot;Doc close without open! After: &quot; + lastDocLine);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">					if (docWasEmpty)</span>
<span class="nc" id="L152">						System.err.println(&quot;Empty document&quot;);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">					if (inSentence)</span>
<span class="nc" id="L154">						out.append(&quot;&lt;/s&gt;\n&quot;); // close last sentence tag!</span>
<span class="nc" id="L155">					inSentence = false;</span>
<span class="nc" id="L156">					inDoc = false;</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">					if (linesDone &gt;= LINES_PER_CHUNK_FILE) {</span>
<span class="nc" id="L158">						shouldContinue = false;</span>
					}
				} else
<span class="nc" id="L161">					System.err.println(&quot;Unknown end tag: &quot; + line);</span>
			} else {
<span class="nc bnc" id="L163" title="All 2 branches missed.">				if (line.equals(&quot;&lt;s&gt;&quot;)) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">					if (inSentence)</span>
<span class="nc" id="L165">						System.err.println(&quot;Nested sentence!&quot;);</span>
<span class="nc" id="L166">					docWasEmpty = false;</span>
<span class="nc" id="L167">					inSentence = true;</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">				} else if (line.equals(&quot;&lt;g/&gt;&quot;)) {</span>
					// do nothing
<span class="nc bnc" id="L170" title="All 2 branches missed.">				} else if (line.startsWith(&quot;&lt;doc&quot;)) {</span>
<span class="nc" id="L171">					lastDocLine = line;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">					if (inDoc) {</span>
<span class="nc" id="L173">						out.append(&quot;&lt;/doc&gt;\n&quot;); // close unclosed doc</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">						System.err.println(&quot;--- Unclosed &quot; + (docWasEmpty ? &quot;empty &quot; : &quot;&quot;)</span>
								+ &quot;document before: &quot; + line);
<span class="nc" id="L176">						System.err.println(&quot;    Fixed: (added close tag)&quot;);</span>
					}

					// Fix o.a. subcorpus=&quot;Domeinen&quot; id=&quot;7637&quot;
					// [v2]
					// line = line.replaceAll(&quot;\\s+jaar=\&quot;(\\d+)\&quot;\&quot;\\s+&quot;, &quot; jaar=\&quot;$1\&quot; &quot;);

					// Quotes om jaar
					// [v2]
					// line = line.replaceAll(&quot;\\s+jaar=(\\d+)\\s+&quot;, &quot; jaar=\&quot;$1\&quot; &quot;);

					// Properly escape &amp;'s
<span class="nc" id="L188">					line = line.replaceAll(&quot;&amp;&quot;, &quot;&amp;amp;&quot;);</span>

					// Spaties normaliseren
<span class="nc" id="L191">					line = line.replaceAll(&quot;\\s\\s+&quot;, &quot; &quot;);</span>

<span class="nc bnc" id="L193" title="All 2 branches missed.">					if (!line.matches(&quot;&lt;doc(\\s+\\w+\\s*=\\s*\&quot;[^&lt;&gt;\&quot;]*\&quot;)*\\s*&gt;\\s*&quot;)) {</span>
<span class="nc" id="L194">						System.err.println(&quot;--- Illegal doc line: &quot; + line);</span>

						// Fix subcorpus=&quot;Pluscorpus&quot; id=&quot;68795&quot;
<span class="nc" id="L197">						line = line.replaceAll(&quot;&lt;URL &gt;&quot;, &quot;url=\&quot;&quot;);</span>
<span class="nc" id="L198">						line = line.replaceAll(&quot;/URL&lt;/URL&gt;&quot;, &quot;\&quot;&quot;);</span>

						// Fix subcorpus=&quot;CLT&quot; id=&quot;69591&quot;
<span class="nc" id="L201">						line = line</span>
<span class="nc" id="L202">								.replaceAll(&quot;&lt;CLTSTRATUM&gt;EON&lt;/CLTSTRATUM&gt;&quot;, &quot;cltstratum=\&quot;EON\&quot;&quot;);</span>

						// Fix subcorpus=&quot;Domeinen&quot; id=&quot;2312&quot;
<span class="nc" id="L205">						line = line.replaceAll(&quot;auteur=\&quot;\&quot; &quot;, &quot;auteur=\&quot;&quot;);</span>

						// [v2]
<span class="nc" id="L208">						line = line.replaceAll(&quot;auteurwebtekst=\&quot;\&quot; &quot;, &quot;auteurwebtekst=\&quot;&quot;);</span>

						// Fix subcorpus=&quot;Domeinen&quot; id=&quot;69831&quot;
<span class="nc" id="L211">						line = line.replaceAll(&quot;&lt;FILEDESC\\s+&gt;DOMEIN\\s+&lt;/FILEDESC&gt;&quot;,</span>
								&quot;filedesc=\&quot;DOMEIN\&quot;&quot;);

						// Fix subcorpus=&quot;CLT&quot; id=&quot;478&quot;
<span class="nc" id="L215">						line = line.replaceAll(&quot;&lt;TEKST&gt;&quot;, &quot;tekst=\&quot;&quot;);</span>
<span class="nc" id="L216">						line = line.replaceAll(&quot;&lt;/TEKST&gt;&quot;, &quot;\&quot;&quot;);</span>

						// Check that that fixed it
<span class="nc bnc" id="L219" title="All 2 branches missed.">						if (!line.matches(&quot;&lt;doc(\\s+\\w+\\s*=\\s*\&quot;[^&lt;&gt;\&quot;]*\&quot;)*\\s*&gt;\\s*&quot;)) {</span>
<span class="nc" id="L220">							System.err.println(&quot;!!! Failed: &quot; + line);</span>
						} else {
<span class="nc" id="L222">							System.err.println(&quot;    Fixed: &quot; + line);</span>
						}
					}

					// Keep track of where we are
<span class="nc" id="L227">					inDoc = true;</span>
<span class="nc" id="L228">					docWasEmpty = true;</span>
				} else
<span class="nc" id="L230">					System.err.println(&quot;Unknown tag: &quot; + line);</span>
			}
<span class="nc" id="L232">			out.append(line);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">		} else if (line.indexOf('\t') &lt; 0) {</span>
			// no tabs; punctuation
<span class="nc" id="L235">			out.append(&quot;&lt;pu&gt;&quot;).append(StringUtil.escapeXmlChars(line)).append(&quot;&lt;/pu&gt;&quot;);</span>
<span class="nc" id="L236">			docWasEmpty = false;</span>
		} else {
<span class="nc" id="L238">			line = StringUtil.escapeXmlChars(line);</span>
<span class="nc" id="L239">			String[] parts = line.split(&quot;\t&quot;, 3);</span>
<span class="nc" id="L240">			out.append(&quot;&lt;w p=\&quot;&quot;).append(parts[1]).append(&quot;\&quot; l=\&quot;&quot;).append(parts[2]).append(&quot;\&quot;&gt;&quot;)</span>
<span class="nc" id="L241">					.append(parts[0]).append(&quot;&lt;/w&gt;&quot;);</span>
<span class="nc" id="L242">			docWasEmpty = false;</span>
		}
<span class="nc" id="L244">		out.append('\n');</span>
<span class="nc" id="L245">		linesDone++;</span>
<span class="nc" id="L246">		return shouldContinue;</span>
	}

	public void convert(Reader in, File outDir, String outFn) throws IOException {
<span class="nc" id="L250">		int chunksDone = 0;</span>
<span class="nc" id="L251">		Writer out = openOutFile(outDir, outFn, chunksDone);</span>
		try {
			BufferedReader br;
<span class="nc bnc" id="L254" title="All 2 branches missed.">			if (!(in instanceof BufferedReader))</span>
<span class="nc" id="L255">				in = new BufferedReader(in);</span>
<span class="nc" id="L256">			br = (BufferedReader) in;</span>
			while (true) {
<span class="nc" id="L258">				String line = br.readLine();</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">				if (line == null)</span>
<span class="nc" id="L260">					break;</span>
<span class="nc" id="L261">				line = line.trim();</span>
<span class="nc" id="L262">				boolean shouldContinueChunk = processLine(line, out);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">				if (!shouldContinueChunk) {</span>
<span class="nc" id="L264">					chunksDone++;</span>
<span class="nc" id="L265">					closeOutFile(out);</span>
<span class="nc" id="L266">					out = openOutFile(outDir, outFn, chunksDone);</span>
				}
<span class="nc" id="L268">			}</span>
		} finally {
<span class="nc" id="L270">			closeOutFile(out);</span>
<span class="nc" id="L271">		}</span>
<span class="nc" id="L272">	}</span>

	private void closeOutFile(Writer out) throws IOException {
<span class="nc bnc" id="L275" title="All 2 branches missed.">		if (inDoc) {</span>
<span class="nc" id="L276">			out.append(&quot;&lt;/doc&gt;\n&quot;); // close unclosed doc</span>
<span class="nc" id="L277">			System.err.println(&quot;Unclosed document at end of chunk&quot;);</span>
		}
<span class="nc" id="L279">		out.append(&quot;&lt;/docs&gt;\n&quot;);</span>
<span class="nc" id="L280">		out.close();</span>
<span class="nc" id="L281">	}</span>

	private Writer openOutFile(File outDir, String outFn, int chunksDone) throws IOException {
<span class="nc" id="L284">		linesDone = 0;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">		if (chunksDone &gt; 0) {</span>
<span class="nc" id="L286">			int punt = outFn.lastIndexOf('.');</span>
<span class="nc" id="L287">			outFn = outFn.substring(0, punt) + &quot; (&quot; + (chunksDone + 1) + &quot;)&quot;</span>
<span class="nc" id="L288">					+ outFn.substring(punt);</span>
		}
<span class="nc" id="L290">		File outFile = new File(outDir, outFn);</span>
<span class="nc" id="L291">		Writer out = new OutputStreamWriter(</span>
				new BufferedOutputStream(new FileOutputStream(outFile)), Indexer.DEFAULT_INPUT_ENCODING);
<span class="nc" id="L293">		String encName = Indexer.DEFAULT_INPUT_ENCODING.name();</span>
<span class="nc" id="L294">		out.append(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;&quot; + encName + &quot;\&quot; ?&gt;\n&quot;)</span>
<span class="nc" id="L295">				.append(&quot;&lt;?xml-stylesheet type=\&quot;text/xsl\&quot; href=\&quot;xsl/corpus.xsl\&quot; ?&gt;\n&quot;)</span>
<span class="nc" id="L296">				.append(&quot;&lt;docs file=\&quot;&quot; + outFn + &quot;\&quot;&gt;\n&quot;);</span>
<span class="nc" id="L297">		return out;</span>
	}

	/**
	 * Convert a list of files.
	 *
	 * @param listFile
	 *            list of files to index (assumed to reside in or under basedir)
	 * @param inDir
	 *            basedir for the files to index
	 * @param outDir where to write output files
	 * @throws Exception
	 */
	private static void convertList(File listFile, File inDir, File outDir) throws Exception {
<span class="nc" id="L311">		SketchToXmlConverter converter = new SketchToXmlConverter();</span>
<span class="nc" id="L312">		List&lt;String&gt; filesToRead = FileUtil.readLines(listFile);</span>
		// Contains a list of files to index
<span class="nc bnc" id="L314" title="All 2 branches missed.">		for (String filePath : filesToRead) {</span>
<span class="nc" id="L315">			File file = new File(inDir, filePath);</span>
<span class="nc" id="L316">			convertFile(converter, file, outDir);</span>
<span class="nc" id="L317">		}</span>
<span class="nc" id="L318">	}</span>

	private static void convertFile(SketchToXmlConverter converter, File inFile, File outDir)
			throws UnsupportedEncodingException, FileNotFoundException, IOException {
<span class="nc" id="L322">		try (Reader in = new InputStreamReader(new FileInputStream(inFile), Indexer.DEFAULT_INPUT_ENCODING)) {</span>
<span class="nc" id="L323">			String fn = inFile.getName();</span>
<span class="nc" id="L324">			String outFn = fn.substring(0, fn.lastIndexOf('.')) + &quot;.xml&quot;;</span>
<span class="nc" id="L325">			converter.convert(in, outDir, outFn);</span>
<span class="nc bnc" id="L326" title="All 8 branches missed.">		}</span>
<span class="nc" id="L327">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>